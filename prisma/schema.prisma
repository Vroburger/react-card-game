generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  collection UserCard[]
  decks      Deck[]
  matches MatchPlayer[]
}

model UserCard {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  cardId     Int
  quantity   Int      @default(1)
  acquiredAt DateTime @default(now())

  @@unique([userId, cardId])
  @@index([userId])
}

model Deck {
  id     Int    @id @default(autoincrement())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int
  name   String

  cards        DeckCard[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  matchPlayers MatchPlayer[]

  @@index([userId])
}

model DeckCard {
  id       Int  @id @default(autoincrement())
  deck     Deck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  deckId   Int
  cardId   Int
  quantity Int  @default(1)

  @@unique([deckId, cardId])
  @@index([deckId])
}

model Match {
  id        Int         @id @default(autoincrement())
  status    MatchStatus @default(PENDING)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  players  MatchPlayer[]
  actions  MatchAction[]
  winnerId Int?

  rngSeed      String?
  initialState Json?

  @@index([winnerId])
}

enum MatchStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

model MatchPlayer {
  id      Int   @id @default(autoincrement())
  match   Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  matchId Int

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int

  deck      Deck?    @relation(fields: [deckId], references: [id], onDelete: SetNull)
  deckId    Int?
  heroHP    Int      @default(30)
  turnOrder Int
  lastSeen  DateTime @default(now())

  actions MatchAction[]

  @@unique([matchId, userId])
  @@index([userId])
  @@index([matchId])
}

model MatchAction {
  id      Int   @id @default(autoincrement())
  match   Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  matchId Int

  player   MatchPlayer? @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId Int?

  turn      Int
  action    Json
  timestamp DateTime @default(now())

  @@index([matchId])
  @@index([playerId])
}
